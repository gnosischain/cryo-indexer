services:
  cryo-indexer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cryo-indexer
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./state:/app/state
      - ./migrations:/app/migrations
    environment:
      - ETH_RPC_URL=${ETH_RPC_URL}
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE:-blockchain}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8443}
      - CLICKHOUSE_SECURE=${CLICKHOUSE_SECURE:-true}
      - CONFIRMATION_BLOCKS=${CONFIRMATION_BLOCKS:-20}
      - POLL_INTERVAL=${POLL_INTERVAL:-15}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CHAIN_ID=${CHAIN_ID:-1}
      - START_BLOCK=${START_BLOCK:-0}
      - MAX_BLOCKS_PER_BATCH=${MAX_BLOCKS_PER_BATCH:-1000}
      - RUN_MIGRATIONS=${RUN_MIGRATIONS:-true}
      - DATASETS=${DATASETS:-blocks,transactions,logs}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
